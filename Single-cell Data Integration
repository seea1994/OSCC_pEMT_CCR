# integration.py: Integrate two single-cell datasets via Scanpy ingest
import scanpy as sc

# Load reference and new AnnData objects (h5ad format)
adata_ref = sc.read_h5ad("path/to/reference_data.h5ad")
adata_new = sc.read_h5ad("path/to/new_data.h5ad")

# Align genes between datasets
common_genes = adata_ref.var_names.intersection(adata_new.var_names)
adata_ref = adata_ref[:, common_genes].copy()
adata_new = adata_new[:, common_genes].copy()

# Preprocess reference: normalize, log, HVGs, PCA, neighbors, UMAP
sc.pp.normalize_total(adata_ref, target_sum=1e4)
sc.pp.log1p(adata_ref)
sc.pp.highly_variable_genes(adata_ref, flavor="seurat", n_top_genes=2000)
adata_ref = adata_ref[:, adata_ref.var.highly_variable]
sc.pp.scale(adata_ref)
sc.tl.pca(adata_ref, n_comps=50)
sc.pp.neighbors(adata_ref, n_neighbors=15, n_pcs=20)
sc.tl.umap(adata_ref)

# Map reference cell_type labels onto new data
sc.tl.ingest(adata_new, adata_ref, obs="cell_type")
adata_new.uns["cell_type_colors"] = adata_ref.uns["cell_type_colors"]
sc.pl.umap(adata_new, color="cell_type", show=False)
